<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Attendance & Personalized Planning System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .view {
            display: none;
        }
        .active-view {
            display: block;
        }
        .status-dot {
            height: 12px;
            width: 12px;
            border-radius: 50%;
            display: inline-block;
            transition: background-color 0.3s ease;
        }
        .status-present {
            background-color: #22c55e; /* green-500 */
        }
        .status-absent {
            background-color: #ef4444; /* red-500 */
        }
        .btn {
            @apply px-4 py-2 rounded-lg font-semibold text-white transition-transform transform hover:scale-105 shadow-md flex items-center justify-center;
        }
        .btn-primary {
            @apply bg-blue-600 hover:bg-blue-700;
        }
        .btn-secondary {
            @apply bg-purple-600 hover:bg-purple-700;
        }
        .card {
            @apply bg-white p-6 rounded-xl shadow-lg border border-gray-200;
        }
        .spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div id="app" class="min-h-screen flex flex-col items-center justify-center p-4">

        <div id="loading-view" class="view active-view text-center">
            <svg class="animate-spin h-10 w-10 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p id="loading-text" class="mt-4 text-lg font-semibold text-gray-600">Initializing System...</p>
        </div>

        <div id="login-view" class="view w-full max-w-sm">
            <div class="card text-center">
                <h1 class="text-3xl font-bold text-blue-700 mb-2">Smart Campus</h1>
                <p class="text-gray-500 mb-6">Please sign in to your account</p>
                <form id="login-form" class="space-y-4">
                    <div>
                        <input type="text" id="username" placeholder="Username (e.g., a, b, dr, admin)" class="w-full px-4 py-2 border rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <input type="password" id="password" placeholder="Password" class="w-full px-4 py-2 border rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-full">Sign In</button>
                </form>
                <p id="login-error" class="text-red-500 text-sm mt-4 h-4"></p>
            </div>
        </div>

        <div id="student-view" class="view w-full max-w-4xl">
            <header class="card mb-4 flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold">Student Dashboard</h1>
                    <p class="text-gray-600">Welcome, <span id="student-name" class="font-semibold"></span>!</p>
                </div>
                <button id="logout-btn" class="btn bg-red-500 hover:bg-red-600">Logout</button>
            </header>
            <div class="grid md:grid-cols-2 gap-6">
                <div class="card">
                    <h2 class="text-xl font-bold mb-4">Today's Schedule</h2>
                    <div id="student-schedule" class="space-y-3">
                        </div>
                </div>
                 <div class="flex flex-col gap-6">
                    <div class="card">
                        <h2 class="text-xl font-bold mb-4">My Goals</h2>
                        <div id="student-goals" class="space-y-2">
                            </div>
                    </div>
                    <div class="card">
                        <h2 class="text-xl font-bold mb-4">Free Period Smart Tasks</h2>
                        <p class="text-sm text-gray-500 mb-4">AI-powered suggestions based on your goals and interests.</p>
                        <button id="generate-tasks-btn" class="btn btn-secondary w-full">
                            ✨ Generate Smart Tasks
                        </button>
                        <div id="tasks-loader" class="hidden text-center mt-4">
                             <div class="spinner h-6 w-6 text-purple-600 mx-auto"></div>
                             <p class="text-sm text-gray-500 mt-2">Generating ideas...</p>
                        </div>
                        <div id="tasks-output" class="mt-4 space-y-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="teacher-view" class="view w-full max-w-5xl">
            <header class="card mb-4 flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold">Teacher Dashboard</h1>
                    <p class="text-gray-600">Welcome, <span id="teacher-name" class="font-semibold"></span>!</p>
                </div>
                <button id="logout-btn-teacher" class="btn bg-red-500 hover:bg-red-600">Logout</button>
            </header>
            <div class="card">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Real-time Attendance</h2>
                    <div class="flex items-center space-x-2">
                        <label for="class-select" class="font-semibold">Current Class:</label>
                        <select id="class-select" class="p-2 border rounded-lg shadow-sm">
                           </select>
                    </div>
                </div>
                <div id="attendance-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                    </div>
                <div class="text-center mt-6">
                     <button id="generate-qr-btn" class="btn btn-primary">Generate New Attendance QR Code</button>
                </div>
            </div>
        </div>

        <div id="admin-view" class="view w-full max-w-4xl">
            <header class="card mb-4 flex justify-between items-center">
                 <div>
                    <h1 class="text-2xl font-bold">Administrator Dashboard</h1>
                    <p class="text-gray-600">Welcome, <span id="admin-name" class="font-semibold"></span>!</p>
                </div>
                 <button id="logout-btn-admin" class="btn bg-red-500 hover:bg-red-600">Logout</button>
            </header>
            <div class="grid md:grid-cols-3 gap-6">
                <div class="card text-center">
                    <h3 class="text-lg font-semibold text-gray-500">Total Students</h3>
                    <p id="total-students" class="text-4xl font-bold text-blue-600">0</p>
                </div>
                <div class="card text-center">
                    <h3 class="text-lg font-semibold text-gray-500">Total Teachers</h3>
                    <p id="total-teachers" class="text-4xl font-bold text-blue-600">0</p>
                </div>
                <div class="card text-center">
                    <h3 class="text-lg font-semibold text-gray-500">Overall Attendance</h3>
                    <p id="overall-attendance" class="text-4xl font-bold text-green-500">0%</p>
                </div>
            </div>
        </div>
    </div>

    <div id="qr-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-2xl shadow-2xl text-center relative max-w-sm w-full">
            <button id="close-qr-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            <h2 class="text-2xl font-bold mb-2">Scan to Mark Attendance</h2>
            <p id="qr-modal-class-info" class="text-gray-600 mb-4"></p>
            <div id="qrcode-container" class="flex justify-center p-4 bg-gray-100 rounded-lg">
                 <canvas id="qrcode"></canvas>
            </div>
            <p class="mt-4 text-sm text-gray-500">This QR code is now active. Generating a new one will disable this one.</p>
        </div>
    </div>

    <div id="goal-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-2xl shadow-2xl relative max-w-lg w-full">
            <button id="close-goal-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            <h2 class="text-2xl font-bold mb-2">✨ AI-Powered Goal Breakdown</h2>
            <p id="goal-modal-title" class="text-gray-600 mb-4"></p>
            <div id="goal-modal-loader" class="hidden text-center my-4">
                <div class="spinner h-8 w-8 text-purple-600 mx-auto"></div>
                <p class="text-sm text-gray-500 mt-2">Breaking it down for you...</p>
            </div>
            <div id="goal-modal-content" class="text-gray-700 space-y-2"></div>
        </div>
    </div>

    <div id="scanner-modal" class="fixed inset-0 bg-gray-900 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white p-6 rounded-2xl shadow-2xl text-center relative max-w-md w-full">
            <button id="close-scanner-modal" class="absolute top-2 right-3 text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            <h2 class="text-xl font-bold mb-4">Scan Attendance QR Code</h2>
            <div id="qr-reader" class="w-full border-4 border-gray-300 rounded-lg overflow-hidden aspect-square max-w-xs mx-auto"></div>
            <p class="mt-4 text-sm text-gray-500">Point your camera at the QR code shown by the teacher.</p>
        </div>
    </div>
    
    <div id="toast-notification" class="fixed bottom-5 left-1/2 -translate-x-1/2 px-6 py-3 rounded-lg text-white font-semibold shadow-lg transition-all duration-300 ease-in-out opacity-0 hidden flex items-center gap-3 z-[100]">
        <span id="toast-icon"></span>
        <span id="toast-message"></span>
    </div>
    
    <script type="module">
        // --- LOCAL DATABASE SIMULATION ---
        const localDB = {
            users: {},
            timetable: {},
            attendance: {},
            activeQrTokens: {} // NEW: To store the currently valid token for each class
        };
        
        // --- MOCK DATA SETUP ---
        function setupInitialData() {
            console.log("Setting up initial data locally...");
            localDB.users = {
                // Students
                'student1': { username: 'a', password: '123', name: 'Alice Johnson', role: 'student', profile: { interests: ['Web Development', 'AI'], goals: ['Build a portfolio website', 'Learn advanced CSS animations'] } },
                'student2': { username: 'b', password: '123', name: 'Bob Williams', role: 'student', profile: { interests: ['Data Science'], goals: ['Learn Python for data analysis'] } },
                'student3': { username: 'c', password: '123', name: 'Charlie Brown', role: 'student', profile: { interests: ['Mobile Development'], goals: ['Create a simple Android app'] } },
                // Teacher
                'teacher1': { username: 'dr', password: 'pass', name: 'Dr. Evelyn Reed', role: 'teacher' },
                // Admin
                'admin1': { username: 'admin', password: 'pass', name: 'Principal Smith', role: 'admin' }
            };
            localDB.timetable = {
                classes: [
                    { classId: 'CS101', subject: 'Intro to Computer Science', teacherId: 'teacher1', students: ['student1', 'student2', 'student3'], time: '09:00 - 10:30' },
                    { classId: 'FREE01', subject: 'Free Period', teacherId: null, students: ['student1', 'student2', 'student3'], time: '10:30 - 11:30' },
                    { classId: 'MA202', subject: 'Calculus II', teacherId: 'teacher1', students: ['student1', 'student2', 'student3'], time: '11:30 - 13:00' }
                ]
            };
            // On initial setup, attendance is empty unless loaded from localStorage
            localDB.attendance = {}; 
            localDB.activeQrTokens = {}; // Reset active tokens on load
            console.log("Initial local data setup complete.");
        }

        // --- GLOBAL STATE ---
        let currentUser = null;
        let html5QrCode = null;

        // --- UI HELPER ---
        function showView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active-view'));
            document.getElementById(viewId).classList.add('active-view');
        }

        // --- TOAST NOTIFICATION ---
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast-notification');
            const toastMessage = document.getElementById('toast-message');
            const toastIcon = document.getElementById('toast-icon');

            toastMessage.textContent = message;
            toast.classList.remove('hidden', 'opacity-0', 'bg-green-500', 'bg-red-500');

            if (type === 'success') {
                toast.classList.add('bg-green-500');
                toastIcon.innerHTML = '✔️';
            } else {
                toast.classList.add('bg-red-500');
                toastIcon.innerHTML = '✖️';
            }
            
            setTimeout(() => {
                toast.classList.add('opacity-0');
                setTimeout(() => toast.classList.add('hidden'), 300);
            }, 3000);
        }

        // --- LOGIN LOGIC ---
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const errorEl = document.getElementById('login-error');
            errorEl.textContent = '';

            const userEntry = Object.entries(localDB.users).find(([id, user]) => user.username === username);

            if (userEntry) {
                const [userId, user] = userEntry;
                if (user.password === password) {
                    currentUser = { id: userId, ...user };
                    loadDashboard(currentUser.role);
                } else {
                    errorEl.textContent = 'Incorrect password.';
                }
            } else {
                errorEl.textContent = 'Username not found.';
            }
        });

        function loadDashboard(role) {
            switch (role) {
                case 'student': renderStudentDashboard(); break;
                case 'teacher': renderTeacherDashboard(); break;
                case 'admin': renderAdminDashboard(); break;
            }
        }
        
        document.querySelectorAll('#logout-btn, #logout-btn-teacher, #logout-btn-admin').forEach(btn => {
            btn.addEventListener('click', () => {
                currentUser = null;
                localStorage.removeItem('attendanceData');
                document.getElementById('login-form').reset();
                showView('login-view');
            });
        });

        // --- GEMINI API INTEGRATION ---
        async function callGeminiAPI(prompt, retries = 3, delay = 1000) {
            const apiKey = "AIzaSyAeoMFZlIuSNN-zrinRbXskkOL0kHSnVDo"; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
            
            const payload = { contents: [{ parts: [{ text: prompt }] }] };

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);
                    
                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        return candidate.content.parts[0].text;
                    } else {
                        throw new Error("Invalid response structure from API.");
                    }
                } catch (error) {
                    console.error(`Attempt ${i + 1} failed:`, error.message);
                    if (i === retries - 1) {
                         return "Sorry, the AI feature is unavailable. Please check your internet connection and API key.";
                    }
                    await new Promise(res => setTimeout(res, delay * Math.pow(2, i)));
                }
            }
        }

        // --- STUDENT DASHBOARD & QR SCANNING ---
        function renderStudentDashboard() {
            document.getElementById('student-name').textContent = currentUser.name;
            const scheduleEl = document.getElementById('student-schedule');
            scheduleEl.innerHTML = '';

            localDB.timetable.classes.forEach(cls => {
                if (!cls.students.includes(currentUser.id)) return;
                const isFreePeriod = cls.subject === 'Free Period';
                const card = document.createElement('div');
                card.className = `p-4 rounded-lg flex justify-between items-center ${isFreePeriod ? 'bg-yellow-100 border-yellow-300' : 'bg-blue-100 border-blue-300'} border-l-4`;
                card.innerHTML = `
                    <div>
                        <p class="font-bold">${cls.subject}</p>
                        <p class="text-sm text-gray-600">${cls.time}</p>
                    </div>
                    ${!isFreePeriod ? `<button data-class-id="${cls.classId}" class="scan-qr-btn btn btn-primary text-sm">Mark Attendance</button>` : '<span class="text-sm font-semibold text-yellow-700">Free Period</span>'}
                `;
                scheduleEl.appendChild(card);
            });

            renderStudentGoals();
            document.getElementById('tasks-output').innerHTML = '';
            showView('student-view');
        }

        function renderStudentGoals() {
            const goalsEl = document.getElementById('student-goals');
            goalsEl.innerHTML = '';
            if (currentUser.profile && currentUser.profile.goals && currentUser.profile.goals.length > 0) {
                currentUser.profile.goals.forEach(goal => {
                    const goalEl = document.createElement('div');
                    goalEl.className = 'bg-gray-50 p-3 rounded-lg border flex justify-between items-center';
                    goalEl.innerHTML = `
                        <p class="text-sm font-medium">${goal}</p>
                        <button data-goal="${goal}" class="breakdown-goal-btn text-xs bg-purple-100 text-purple-700 font-semibold px-2 py-1 rounded-md hover:bg-purple-200">✨ Break down</button>
                    `;
                    goalsEl.appendChild(goalEl);
                });
            } else {
                goalsEl.innerHTML = `<p class="text-sm text-gray-500">No goals set yet.</p>`;
            }
        }

        document.getElementById('student-schedule').addEventListener('click', (e) => {
            if (e.target.classList.contains('scan-qr-btn')) {
                const classId = e.target.dataset.classId;
                startScanner(classId);
            }
        });

        function startScanner(targetClassId) {
            const modal = document.getElementById('scanner-modal');
            modal.classList.remove('hidden');

            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().catch(err => console.error("Failed to stop previous scanner.", err));
            }

            html5QrCode = new Html5Qrcode("qr-reader");

            const onScanSuccess = (decodedText, decodedResult) => {
                try {
                    const data = JSON.parse(decodedText);
                    const activeToken = localDB.activeQrTokens[data.classId];
                    
                    // UPDATED: Validation logic now checks for a matching token
                    if (data.classId && data.classId === targetClassId && data.token && data.token === activeToken) {
                        html5QrCode.stop().then(() => {
                            modal.classList.add('hidden');
                            markAttendance(currentUser.id, data.classId);
                        }).catch(err => console.error("Failed to stop scanner after success.", err));
                    } else if (data.classId !== targetClassId) {
                        showToast('Incorrect QR Code. This is for another class.', 'error');
                    } else {
                         showToast('This QR code has expired. Please scan the new one.', 'error');
                    }
                } catch (e) {
                    console.error("Failed to parse QR code data", e);
                    showToast("Invalid QR Code format.", 'error');
                }
            };

            const onScanFailure = (error) => { /* Ignore frequent errors */ };
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };

            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
                .catch((err) => {
                    console.error(`Unable to start scanning, error=${err}`);
                    showToast('Could not start camera. Please grant permissions.', 'error');
                    modal.classList.add('hidden');
                });
        }
        
        document.getElementById('close-scanner-modal').addEventListener('click', () => {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().catch(err => console.error("Failed to stop scanner on close.", err));
            }
            document.getElementById('scanner-modal').classList.add('hidden');
        });

        function markAttendance(studentId, classId) {
            const today = new Date().toISOString().split('T')[0];
            const attendanceId = `${today}_${classId}_${studentId}`;
            localDB.attendance[attendanceId] = { studentId, classId, date: today, timestamp: new Date(), status: 'present' };
            
            localStorage.setItem('attendanceData', JSON.stringify(localDB.attendance));
            
            showToast('Attendance marked successfully!');

            const teacherView = document.getElementById('teacher-view');
            if (teacherView.classList.contains('active-view')) {
                const selectedClass = document.getElementById('class-select').value;
                if (selectedClass === classId) {
                    loadAttendanceForClass(classId);
                }
            }
        }

        document.getElementById('generate-tasks-btn').addEventListener('click', async () => {
            const loader = document.getElementById('tasks-loader');
            const output = document.getElementById('tasks-output');
            const btn = document.getElementById('generate-tasks-btn');
            
            loader.classList.remove('hidden');
            output.innerHTML = '';
            btn.disabled = true;

            const interests = currentUser.profile.interests.join(', ');
            const goals = currentUser.profile.goals.join(', ');
            const prompt = `Act as a helpful academic advisor. For a student interested in "${interests}" with long-term goals like "${goals}", suggest 3 specific, actionable, and creative tasks they can complete in a 1-hour free period. Format the response as a numbered list with bold headings for each task, followed by a brief one-sentence description. For example:\n1. **Task Title:** Description of the task.`;
            
            const result = await callGeminiAPI(prompt);
            
            const formattedResult = result
                .replace(/\*\*(.*?)\*\*/g, '<strong class="text-purple-700">$1</strong>')
                .replace(/^\d\.\s/gm, '<li class="ml-4 list-decimal">');

            output.innerHTML = `<ul class="space-y-2">${formattedResult}</ul>`;
            loader.classList.add('hidden');
            btn.disabled = false;
        });

        document.getElementById('student-goals').addEventListener('click', (e) => {
            if (e.target.classList.contains('breakdown-goal-btn')) {
                const goal = e.target.dataset.goal;
                breakDownGoal(goal);
            }
        });

        async function breakDownGoal(goal) {
            const modal = document.getElementById('goal-modal');
            const loader = document.getElementById('goal-modal-loader');
            const content = document.getElementById('goal-modal-content');
            
            modal.classList.remove('hidden');
            loader.classList.remove('hidden');
            content.innerHTML = '';
            document.getElementById('goal-modal-title').textContent = `Breaking down: "${goal}"`;

            const prompt = `Break down this large goal: "${goal}" into 5 smaller, manageable steps for a student. Provide a simple numbered list with clear, actionable steps.`;
            const result = await callGeminiAPI(prompt);
            
            const formattedResult = result.replace(/^(\d+)\.\s(.*?)$/gm, (match, number, text) => {
                return `<div class="flex items-start gap-3 mt-2">
                            <span class="flex-shrink-0 bg-purple-100 text-purple-700 font-bold w-6 h-6 text-sm rounded-full flex items-center justify-center">${number}</span>
                            <p>${text.trim()}</p>
                        </div>`;
            });

            content.innerHTML = formattedResult;
            loader.classList.add('hidden');
        }

        document.getElementById('close-goal-modal').addEventListener('click', () => {
             document.getElementById('goal-modal').classList.add('hidden');
        });

        // --- TEACHER DASHBOARD ---
        function renderTeacherDashboard() {
            document.getElementById('teacher-name').textContent = currentUser.name;
            const classSelect = document.getElementById('class-select');
            classSelect.innerHTML = '';

            const classes = localDB.timetable.classes.filter(c => c.teacherId === currentUser.id);
            classes.forEach(cls => {
                const option = document.createElement('option');
                option.value = cls.classId;
                option.textContent = `${cls.classId} - ${cls.subject}`;
                classSelect.appendChild(option);
            });
            if (classes.length > 0) {
                loadAttendanceForClass(classes[0].classId);
            }
            
            classSelect.addEventListener('change', (e) => loadAttendanceForClass(e.target.value));
            document.getElementById('generate-qr-btn').addEventListener('click', generateQrCode);
            showView('teacher-view');
        }
        
        function loadAttendanceForClass(classId) {
            const attendanceGrid = document.getElementById('attendance-grid');
            attendanceGrid.innerHTML = '';

            const classInfo = localDB.timetable.classes.find(c => c.classId === classId);
            const studentIds = classInfo.students;
            
            const today = new Date().toISOString().split('T')[0];

            studentIds.forEach(studentId => {
                const studentData = localDB.users[studentId];
                if(studentData){
                    const attendanceId = `${today}_${classId}_${studentId}`;
                    const isPresent = localDB.attendance[attendanceId]?.status === 'present';

                    const studentCard = document.createElement('div');
                    studentCard.className = 'p-3 rounded-lg border flex items-center space-x-3 bg-gray-50';
                    studentCard.innerHTML = `
                        <span class="status-dot ${isPresent ? 'status-present' : 'status-absent'}"></span>
                        <div>
                            <p class="font-semibold text-sm">${studentData.name}</p>
                            <p class="text-xs text-gray-500">${studentId}</p>
                        </div>
                    `;
                    attendanceGrid.appendChild(studentCard);
                }
            });
        }
        
        function generateQrCode() {
            const classId = document.getElementById('class-select').value;
            if(!classId) {
                showToast("Please select a class first.", "error");
                return;
            }
            
            // NEW: Generate a unique token and store it
            const token = `${classId}-${Date.now()}-${Math.random()}`;
            localDB.activeQrTokens[classId] = token;
            console.log(`New token for ${classId}: ${token}`);

            // NEW: Embed the token in the QR code data
            const qrData = JSON.stringify({ classId: classId, token: token });

            QRCode.toCanvas(document.getElementById('qrcode'), qrData, { width: 200 }, function (error) {
                if (error) {
                    console.error(error);
                    return;
                }
                document.getElementById('qr-modal-class-info').textContent = `For class: ${classId}`;
                document.getElementById('qr-modal').classList.remove('hidden');
            });
        }
        
        document.getElementById('close-qr-modal').addEventListener('click', () => {
             document.getElementById('qr-modal').classList.add('hidden');
        });

        // --- ADMIN DASHBOARD ---
        function renderAdminDashboard() {
            document.getElementById('admin-name').textContent = currentUser.name;
            let studentCount = 0;
            let teacherCount = 0;
            Object.values(localDB.users).forEach(user => {
                if (user.role === 'student') studentCount++;
                if (user.role === 'teacher') teacherCount++;
            });
            
            const presentCount = Object.keys(localDB.attendance).length;
            const totalPossibleAttendances = studentCount * localDB.timetable.classes.filter(c => c.teacherId !== null).length;
            const attendancePercentage = totalPossibleAttendances > 0 ? ((presentCount / totalPossibleAttendances) * 100).toFixed(1) : 0;

            document.getElementById('total-students').textContent = studentCount;
            document.getElementById('total-teachers').textContent = teacherCount;
            document.getElementById('overall-attendance').textContent = `${attendancePercentage}%`;

            showView('admin-view');
        }

        // --- INITIALIZE THE APP ---
        function initializeApp() {
            setupInitialData();
            const savedAttendance = localStorage.getItem('attendanceData');
            if (savedAttendance) {
                localDB.attendance = JSON.parse(savedAttendance);
                console.log("Loaded attendance data from localStorage.");
            }
            showView('login-view');
            document.getElementById('loading-view').classList.remove('active-view');
        }
        initializeApp();

    </script>

</body>
</html>
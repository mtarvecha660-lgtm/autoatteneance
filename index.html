<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Attendance & Personalized Planning System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow-x: hidden;
        }

        /* --- View Transition System --- */
        .view {
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94), transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: absolute; /* Needed for smooth transitions */
            width: 100%;
            padding: 1rem;
        }
        .active-view {
            display: block; /* Will be toggled by JS */
            opacity: 1;
            transform: translateY(0);
            position: relative;
        }
        /* Ensure flex containers get 'display: flex' */
        #student-view.active-view, #admin-view.active-view, #teacher-view.active-view, #event-manager-view.active-view {
            display: flex;
            flex-direction: column;
        }

        /* --- Glassmorphism Card Style --- */
        .card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 1.5rem;
            border-radius: 1.5rem; /* Larger radius */
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.18);
            color: #fff;
        }
        
        .card h1, .card h2, .card h3 {
             color: #fff;
        }
        .card p, .card span, .card label {
            color: #e0e0e0;
        }

        /* --- Enhanced Button Styles --- */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 700; /* Bolder */
            color: #fff;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            gap: 0.5rem;
            border: none;
            cursor: pointer;
        }
        .btn:hover { transform: translateY(-3px) scale(1.03); box-shadow: 0 8px 25px rgba(0,0,0,0.2); }
        .btn:active { transform: translateY(-1px) scale(0.99); }
        
        .btn-primary { background: linear-gradient(45deg, #3b82f6, #6366f1); }
        .btn-secondary { background: linear-gradient(45deg, #8b5cf6, #d946ef); }
        .btn-danger { background: linear-gradient(45deg, #ef4444, #f97316); }
        .btn-success { background: linear-gradient(45deg, #22c55e, #14b8a6); }

        /* --- Input Fields --- */
        input, select, textarea {
            background-color: rgba(255, 255, 255, 0.1) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            color: white !important;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
            width: 100%;
        }
        input::placeholder, textarea::placeholder { color: #ccc !important; }
        input:focus, select:focus, textarea:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.5);
            background-color: rgba(255, 255, 255, 0.2) !important;
        }
        /* Fix for date/time input icon colors */
        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }

        /* --- Status Indicators --- */
        .status-dot {
            height: 12px;
            width: 12px;
            border-radius: 50%;
            display: inline-block;
            transition: all 0.3s ease;
            box-shadow: 0 0 8px 2px rgba(0,0,0,0.2);
        }
        .status-present { background-color: #4ade80; box-shadow: 0 0 10px #4ade80; }
        .status-absent { background-color: #f87171; box-shadow: 0 0 10px #f87171; }

        /* --- Animations --- */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeInUp {
            animation: fadeInUp 0.6s ease-out forwards;
        }
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .hidden { display: none !important; }
        
        /* --- Modal Backdrop --- */
        .modal-backdrop {
            background-color: rgba(10, 5, 30, 0.5);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        .modal-content {
             background: linear-gradient(135deg, #4b5563, #1f2937); /* Darker gradient for modals */
        }
    </style>
</head>
<body class="antialiased text-gray-200">

    <div id="app" class="min-h-screen w-full flex flex-col items-center justify-center p-4 relative overflow-hidden">

        <div id="loading-view" class="view active-view text-center">
            <svg class="animate-spin h-10 w-10 text-white mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p id="loading-text" class="mt-4 text-lg font-semibold text-gray-300">Initializing System...</p>
        </div>

        <div id="login-view" class="view w-full max-w-sm">
            <div class="card animate-fadeInUp">
                <div class="text-center">
                    <h1 class="text-4xl font-extrabold text-white mb-2 tracking-tight">Smart Campus</h1>
                    <p class="text-gray-300 mb-8">Sign in to your dashboard</p>
                </div>
                <form id="login-form" class="space-y-6">
                    <div>
                        <input type="text" id="username" placeholder="Username" class="w-full shadow-sm" required>
                    </div>
                    <div>
                        <input type="password" id="password" placeholder="Password" class="w-full shadow-sm" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-full !py-3 !text-base">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                        Sign In Securely
                    </button>
                </form>
                <p id="login-error" class="text-red-400 text-sm mt-4 h-4 text-center"></p>
            </div>
        </div>

        <div id="student-view" class="view w-full max-w-5xl flex-col" style="display: none;">
            <header class="card mb-6 flex justify-between items-center animate-fadeInUp" style="animation-delay: 0.1s;">
                <div>
                    <h1 class="text-3xl font-bold">Student Dashboard</h1>
                    <p class="text-gray-300">Welcome, <span id="student-name" class="font-semibold text-white"></span>!</p>
                </div>
                <button id="logout-btn" class="btn btn-danger">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                    Logout
                </button>
            </header>

            <div id="student-events-section" class="card mb-6 w-full animate-fadeInUp" style="animation-delay: 0.2s;">
                <h2 class="text-2xl font-bold mb-4">Campus Events</h2>
                <div class="space-y-6">
                    <div>
                        <h3 class="text-lg font-semibold text-green-400 mb-2">🟢 Ongoing</h3>
                        <div id="ongoing-events" class="space-y-2"></div>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-blue-400 mb-2">🔼 Upcoming</h3>
                        <div id="upcoming-events" class="space-y-2"></div>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-400 mb-2">🔽 Past</h3>
                        <div id="past-events" class="space-y-2"></div>
                    </div>
                </div>
            </div>

            <div class="grid md:grid-cols-2 gap-6 w-full">
                <div class="card animate-fadeInUp" style="animation-delay: 0.3s;">
                    <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                        Today's Schedule
                    </h2>
                    <div id="student-schedule" class="space-y-4"></div>
                </div>
                <div class="flex flex-col gap-6">
                    <div class="card animate-fadeInUp" style="animation-delay: 0.4s;">
                        <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg>
                            My Goals
                        </h2>
                        <div id="student-goals" class="space-y-3"></div>
                    </div>
                    <div class="card animate-fadeInUp" style="animation-delay: 0.5s;">
                        <h2 class="text-2xl font-bold mb-4">Free Period Smart Tasks</h2>
                        <p class="text-sm text-gray-300 mb-4">AI-powered suggestions based on your goals and interests.</p>
                        <button id="generate-tasks-btn" class="btn btn-secondary w-full">
                            ✨ Generate Smart Tasks
                        </button>
                        <div id="tasks-loader" class="hidden text-center mt-4">
                            <div class="spinner h-6 w-6 text-fuchsia-400 mx-auto"></div>
                            <p class="text-sm text-gray-400 mt-2">Generating ideas...</p>
                        </div>
                        <div id="tasks-output" class="mt-4 space-y-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="teacher-view" class="view w-full max-w-6xl flex-col" style="display: none;">
            <header class="card mb-6 flex justify-between items-center animate-fadeInUp" style="animation-delay: 0.1s;">
                <div>
                    <h1 class="text-3xl font-bold">Teacher Dashboard</h1>
                    <p class="text-gray-300">Welcome, <span id="teacher-name" class="font-semibold text-white"></span>!</p>
                </div>
                <button id="logout-btn-teacher" class="btn btn-danger">
                    Logout
                </button>
            </header>
            <div class="card w-full animate-fadeInUp" style="animation-delay: 0.2s;">
                 <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold">Real-time Attendance</h2>
                    <div class="flex items-center space-x-2 bg-white/10 p-2 rounded-lg">
                        <label for="class-select" class="font-semibold text-sm">Current Class:</label>
                        <select id="class-select" class="p-2 border-0 shadow-sm !rounded-md"></select>
                    </div>
                </div>
                <div id="attendance-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
                <div class="text-center mt-8 border-t border-white/10 pt-6">
                    <button id="generate-qr-btn" class="btn btn-primary">
                        Generate New Attendance QR Code
                    </button>
                </div>
            </div>
        </div>

        <div id="admin-view" class="view w-full max-w-5xl flex-col" style="display: none;">
             <header class="card mb-6 flex justify-between items-center animate-fadeInUp" style="animation-delay: 0.1s;">
                <div>
                    <h1 class="text-3xl font-bold">Administrator Dashboard</h1>
                    <p class="text-gray-300">Welcome, <span id="admin-name" class="font-semibold text-white"></span>!</p>
                </div>
                <button id="logout-btn-admin" class="btn btn-danger">
                    Logout
                </button>
            </header>
            <div class="grid md:grid-cols-3 gap-6 w-full">
                <div class="card text-center animate-fadeInUp" style="animation-delay: 0.2s;">
                    <h3 class="text-lg font-semibold text-gray-300">Total Students</h3>
                    <p id="total-students" class="text-5xl font-extrabold text-white mt-2">0</p>
                </div>
                <div class="card text-center animate-fadeInUp" style="animation-delay: 0.3s;">
                    <h3 class="text-lg font-semibold text-gray-300">Total Teachers</h3>
                    <p id="total-teachers" class="text-5xl font-extrabold text-white mt-2">0</p>
                </div>
                <div class="card text-center animate-fadeInUp" style="animation-delay: 0.4s;">
                    <h3 class="text-lg font-semibold text-gray-300">Overall Attendance</h3>
                    <p id="overall-attendance" class="text-5xl font-extrabold text-green-400 mt-2">0%</p>
                </div>
            </div>
        </div>

        <div id="event-manager-view" class="view w-full max-w-6xl flex-col" style="display: none;">
            <header class="card mb-6 flex justify-between items-center animate-fadeInUp" style="animation-delay: 0.1s;">
                <div>
                    <h1 class="text-3xl font-bold">Event Manager Dashboard</h1>
                    <p class="text-gray-300">Welcome, <span id="event-manager-name" class="font-semibold text-white"></span>!</p>
                </div>
                <button id="logout-btn-event-manager" class="btn btn-danger">
                    Logout
                </button>
            </header>
            <div class="grid md:grid-cols-2 gap-6 w-full">
                <div class="card animate-fadeInUp" style="animation-delay: 0.2s;">
                    <h2 class="text-2xl font-bold mb-4">Create New Event</h2>
                    <form id="create-event-form" class="space-y-4">
                        <input type="text" id="event-title" placeholder="Event Title" required>
                        <div class="grid grid-cols-2 gap-4">
                            <input type="date" id="event-date" required>
                            <input type="time" id="event-start-time" required>
                        </div>
                        <input type="time" id="event-end-time" placeholder="End Time" required>
                        <input type="text" id="event-location" placeholder="Location (e.g., Auditorium)" required>
                        <input type="text" id="event-organizer" placeholder="Organizer (e.g., CS Department)" required>
                        <textarea id="event-description" placeholder="Full event description..." rows="4" required></textarea>
                        <button type="submit" class="btn btn-success w-full">Create Event</button>
                    </form>
                </div>
                <div class="card animate-fadeInUp" style="animation-delay: 0.3s;">
                    <h2 class="text-2xl font-bold mb-4">Current Events</h2>
                    <div id="event-list-manager" class="space-y-3 max-h-96 overflow-y-auto">
                        </div>
                </div>
            </div>
        </div>

    </div>

    <div id="qr-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center hidden z-50">
        <div class="modal-content p-8 rounded-2xl shadow-2xl text-center relative max-w-sm w-full animate-fadeInUp">
            <button id="close-qr-modal" aria-label="Close" class="absolute top-4 right-4 text-gray-400 hover:text-white text-3xl">&times;</button>
            <h2 class="text-2xl font-bold mb-2 text-white">Scan to Mark Attendance</h2>
            <p id="qr-modal-class-info" class="text-gray-300 mb-4"></p>
            <div id="qrcode-container" class="flex justify-center p-4 bg-white rounded-lg">
                <canvas id="qrcode"></canvas>
            </div>
            <p class="mt-4 text-sm text-gray-400">This QR code is now active.</p>
        </div>
    </div>

    <div id="goal-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center hidden z-50">
        <div class="modal-content p-8 rounded-2xl shadow-2xl relative max-w-lg w-full animate-fadeInUp">
            <button id="close-goal-modal" aria-label="Close" class="absolute top-4 right-4 text-gray-400 hover:text-white text-3xl">&times;</button>
            <h2 class="text-2xl font-bold mb-2 text-white">✨ AI-Powered Goal Breakdown</h2>
            <p id="goal-modal-title" class="text-gray-300 mb-4"></p>
            <div id="goal-modal-loader" class="hidden text-center my-4">
                <div class="spinner h-8 w-8 text-fuchsia-400 mx-auto"></div>
                <p class="text-sm text-gray-400 mt-2">Breaking it down for you...</p>
            </div>
            <div id="goal-modal-content" class="text-gray-300 space-y-2"></div>
        </div>
    </div>
    
    <div id="event-details-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center hidden z-50 p-4">
        <div class="modal-content p-8 rounded-2xl shadow-2xl relative max-w-2xl w-full animate-fadeInUp">
            <button id="close-event-modal" aria-label="Close" class="absolute top-4 right-4 text-gray-400 hover:text-white text-3xl">&times;</button>
            <h2 id="event-modal-title" class="text-3xl font-bold mb-2 text-white"></h2>
            <div class="flex flex-wrap gap-x-6 gap-y-2 text-gray-300 mb-4 border-b border-white/10 pb-4">
                <p><strong>Date:</strong> <span id="event-modal-date"></span></p>
                <p><strong>Time:</strong> <span id="event-modal-time"></span></p>
                <p><strong>Location:</strong> <span id="event-modal-location"></span></p>
                <p><strong>Organizer:</strong> <span id="event-modal-organizer"></span></p>
            </div>
            <div id="event-modal-description" class="text-gray-200"></div>
        </div>
    </div>


    <div id="scanner-modal" class="fixed inset-0 bg-gray-900 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white p-6 rounded-2xl shadow-2xl text-center relative max-w-md w-full animate-fadeInUp">
            <button id="close-scanner-modal" aria-label="Close" class="absolute top-2 right-3 text-gray-600 hover:text-gray-900 text-3xl">&times;</button>
            <h2 class="text-xl font-bold mb-4 text-gray-800">Scan Attendance QR Code</h2>
            <div id="qr-reader" class="w-full border-4 border-gray-300 rounded-lg overflow-hidden aspect-square max-w-xs mx-auto"></div>
            <p class="mt-4 text-sm text-gray-500">Point your camera at the QR code shown by the teacher.</p>
        </div>
    </div>
    
    <div id="toast-notification" class="fixed bottom-5 left-1/2 -translate-x-1/2 px-6 py-3 rounded-lg text-white font-semibold shadow-lg transition-all duration-300 ease-in-out opacity-0 translate-y-4 hidden items-center gap-3 z-[100]">
        <span id="toast-icon"></span>
        <span id="toast-message"></span>
    </div>
    
<script type="module">
    // --- LOCAL DATABASE SIMULATION ---
    const localDB = {
        users: {},
        timetable: {},
        attendance: {},
        activeQrTokens: {},
        events: []
    };
    
    // --- CONFIG ---
    const GEMINI_API_KEY = null; 

    // --- MOCK DATA SETUP ---
    function setupInitialData() {
        localDB.users = {
            'student1': { username: 'a', password: '123', name: 'Alice Johnson', role: 'student', profile: { interests: ['Web Development', 'AI'], goals: ['Build a portfolio website', 'Learn advanced CSS animations'] } },
            'student2': { username: 'b', password: '123', name: 'Bob Williams', role: 'student', profile: { interests: ['Data Science'], goals: ['Learn Python for data analysis'] } },
            'teacher1': { username: 'dr', password: 'pass', name: 'Dr. Evelyn Reed', role: 'teacher' },
            'admin1': { username: 'admin', password: 'pass', name: 'Principal Smith', role: 'admin' },
            'eventmgr1': { username: 'eventmgr', password: 'pass', name: 'Chris Green', role: 'event-manager' }
        };
        localDB.timetable = {
            classes: [
                { classId: 'CS101', subject: 'Intro to CompSci', teacherId: 'teacher1', students: ['student1', 'student2'], time: '09:00 - 10:30' },
                { classId: 'MA202', subject: 'Calculus II', teacherId: 'teacher1', students: ['student1', 'student2'], time: '11:30 - 13:00' }
            ]
        };
        
        // Sample Events for testing
        const today = new Date();
        const yesterday = new Date(today); yesterday.setDate(yesterday.getDate() - 1);
        const tomorrow = new Date(today); tomorrow.setDate(tomorrow.getDate() + 1);

        localDB.events = [
            { id: 'evt-1', title: 'Annual Tech Symposium', date: yesterday.toISOString().split('T')[0], startTime: '10:00', endTime: '16:00', location: 'Main Auditorium', organizer: 'Tech Club', description: 'A full day of talks and workshops from industry experts on the latest trends in technology.' },
            { id: 'evt-2', title: 'Guest Lecture: AI Ethics', date: today.toISOString().split('T')[0], startTime: '14:00', endTime: '15:30', location: 'Hall C', organizer: 'Philosophy Dept.', description: 'Join us for an insightful lecture on the ethical implications of artificial intelligence with guest speaker Dr. Anya Sharma.' },
            { id: 'evt-3', title: 'Startup Pitch Night', date: tomorrow.toISOString().split('T')[0], startTime: '18:00', endTime: '20:00', location: 'Innovation Hub', organizer: 'Entrepreneurship Cell', description: 'Watch students pitch their innovative startup ideas to a panel of judges. Networking session to follow.' },
        ];
        
        localDB.attendance = {}; 
        localDB.activeQrTokens = {};
    }

    // --- GLOBAL STATE & UI HELPERS ---
    let currentUser = null;
    let html5QrCode = null;

    function showView(viewId) {
        const currentActive = document.querySelector('.active-view');
        if (currentActive) {
            currentActive.classList.remove('active-view');
            setTimeout(() => { if (!currentActive.classList.contains('active-view')) currentActive.style.display = 'none'; }, 500);
        }
        const view = document.getElementById(viewId);
        if (view) {
            const displayStyle = ['student-view', 'teacher-view', 'admin-view', 'event-manager-view'].includes(viewId) ? 'flex' : 'block';
            view.style.display = displayStyle;
            setTimeout(() => view.classList.add('active-view'), 10);
        }
    }

    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast-notification');
        const toastMessage = document.getElementById('toast-message');
        const toastIcon = document.getElementById('toast-icon');

        toastMessage.textContent = message;
        toast.classList.remove('hidden', 'bg-green-500', 'bg-red-500', 'opacity-0', 'translate-y-4');

        if (type === 'success') {
            toast.classList.add('bg-green-500');
            toastIcon.textContent = '✔️';
        } else {
            toast.classList.add('bg-red-500');
            toastIcon.textContent = '✖️';
        }
        
        let toastTimeout = null;
        if (toastTimeout) clearTimeout(toastTimeout);
        toast.classList.remove('hidden');
        setTimeout(() => {
            toast.classList.remove('opacity-0', 'translate-y-4');
        }, 10);

        toastTimeout = setTimeout(() => {
            toast.classList.add('opacity-0', 'translate-y-4');
            setTimeout(() => toast.classList.add('hidden'), 300);
        }, 3000);
    }

    // --- LOGIN & ROUTING ---
    document.getElementById('login-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;
        const userEntry = Object.entries(localDB.users).find(([id, user]) => user.username === username);

        if (userEntry) {
            const [userId, user] = userEntry;
            if (user.password === password) {
                currentUser = { id: userId, ...user };
                loadDashboard(currentUser.role);
            } else {
                document.getElementById('login-error').textContent = 'Incorrect password.';
            }
        } else {
            document.getElementById('login-error').textContent = 'Username not found.';
        }
    });

    function loadDashboard(role) {
        switch (role) {
            case 'student': renderStudentDashboard(); break;
            case 'teacher': renderTeacherDashboard(); break;
            case 'admin': renderAdminDashboard(); break;
            case 'event-manager': renderEventManagerDashboard(); break;
        }
    }
    
    document.querySelectorAll('#logout-btn, #logout-btn-teacher, #logout-btn-admin, #logout-btn-event-manager').forEach(btn => {
        btn.addEventListener('click', () => {
            currentUser = null;
            document.getElementById('login-form').reset();
            document.getElementById('login-error').textContent = '';
            showView('login-view');
        });
    });

    // --- GEMINI API (Placeholder) ---
    async function callGeminiAPI(prompt) { 
         console.warn("GEMINI_API_KEY not set. Returning mock response.");
         if (prompt.toLowerCase().includes("act as a helpful academic advisor")) {
             return `1. **Mini Project:** Build a 1-hour mini portfolio page.\n2. **Data Exercise:** Analyze a small dataset.\n3. **Skill Sprint:** Follow a 20-minute tutorial on a new tool.`;
         }
         if (prompt.toLowerCase().includes("break down this large goal")) {
             return `1. Identify the core outcome.\n2. Research 3 example projects.\n3. Outline milestones.\n4. Gather resources.\n5. Execute the first small milestone.`;
         }
         return "AI feature is not configured.";
    }

    // --- STUDENT DASHBOARD ---
    function renderStudentDashboard() {
        document.getElementById('student-name').textContent = currentUser.name;
        // **FIXED HERE**: The following lines were missing
        renderStudentSchedule();
        renderStudentGoals();
        document.getElementById('tasks-output').innerHTML = '';
        // End of fix
        renderStudentEvents();
        showView('student-view');
    }

    function renderStudentSchedule() {
        const scheduleEl = document.getElementById('student-schedule');
        scheduleEl.innerHTML = '';
        const studentClasses = localDB.timetable.classes.filter(cls => cls.students.includes(currentUser.id));

        if (studentClasses.length === 0) {
             scheduleEl.innerHTML = `<p class="text-sm text-gray-400">You are not enrolled in any classes today.</p>`;
             return;
        }

        studentClasses.forEach(cls => {
            const isFreePeriod = cls.subject === 'Free Period';
            const card = document.createElement('div');
            card.className = `p-4 rounded-lg flex justify-between items-center bg-white/5 border-l-4 ${isFreePeriod ? 'border-amber-400' : 'border-blue-400'}`;
            card.innerHTML = `
                <div>
                    <p class="font-bold text-white">${cls.subject}</p>
                    <p class="text-sm text-gray-300">${cls.time}</p>
                </div>
                ${!isFreePeriod ? `<button data-class-id="${cls.classId}" class="scan-qr-btn btn btn-primary text-sm">Mark Attendance</button>` : '<span class="text-sm font-semibold text-amber-400">Free Period</span>'}
            `;
            scheduleEl.appendChild(card);
        });
    }
    
    function renderStudentGoals() {
        const goalsEl = document.getElementById('student-goals');
        goalsEl.innerHTML = '';
        if (currentUser.profile && currentUser.profile.goals && currentUser.profile.goals.length > 0) {
            currentUser.profile.goals.forEach(goal => {
                const goalEl = document.createElement('div');
                goalEl.className = 'bg-white/5 p-3 rounded-lg border border-white/10 flex justify-between items-center';
                goalEl.innerHTML = `
                    <p class="text-sm font-medium text-gray-200">${goal}</p>
                    <button data-goal="${goal}" class="breakdown-goal-btn text-xs bg-fuchsia-500/20 text-fuchsia-300 font-semibold px-2 py-1 rounded-md hover:bg-fuchsia-500/40 transition-colors">✨ Break down</button>
                `;
                goalsEl.appendChild(goalEl);
            });
        } else {
            goalsEl.innerHTML = `<p class="text-sm text-gray-400">No goals set yet.</p>`;
        }
    }

    function renderStudentEvents() {
        const ongoingContainer = document.getElementById('ongoing-events');
        const upcomingContainer = document.getElementById('upcoming-events');
        const pastContainer = document.getElementById('past-events');
        [ongoingContainer, upcomingContainer, pastContainer].forEach(c => c.innerHTML = '');

        const now = new Date();
        let hasOngoing = false, hasUpcoming = false, hasPast = false;

        localDB.events.forEach(event => {
            const eventStart = new Date(`${event.date}T${event.startTime}`);
            const eventEnd = new Date(`${event.date}T${event.endTime}`);
            
            const eventEl = document.createElement('button');
            eventEl.className = 'w-full text-left p-3 rounded-lg bg-white/5 hover:bg-white/10 transition-colors flex justify-between items-center';
            eventEl.dataset.eventId = event.id;
            eventEl.innerHTML = `
                <div>
                    <p class="font-semibold text-white">${event.title}</p>
                    <p class="text-sm text-gray-300">${new Date(event.date + 'T00:00:00').toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric' })}</p>
                </div>
                <span class="text-xs font-bold text-gray-400">></span>
            `;

            if (now >= eventStart && now <= eventEnd) {
                ongoingContainer.appendChild(eventEl);
                hasOngoing = true;
            } else if (now < eventStart) {
                upcomingContainer.appendChild(eventEl);
                hasUpcoming = true;
            } else {
                pastContainer.appendChild(eventEl);
                hasPast = true;
            }
        });

        if (!hasOngoing) ongoingContainer.innerHTML = `<p class="text-sm text-gray-400">No events currently ongoing.</p>`;
        if (!hasUpcoming) upcomingContainer.innerHTML = `<p class="text-sm text-gray-400">No upcoming events scheduled.</p>`;
        if (!hasPast) pastContainer.innerHTML = `<p class="text-sm text-gray-400">No past events found.</p>`;
    }

    document.getElementById('student-events-section').addEventListener('click', e => {
        const eventButton = e.target.closest('button[data-event-id]');
        if (eventButton) {
            const eventId = eventButton.dataset.eventId;
            const event = localDB.events.find(ev => ev.id === eventId);
            if (event) showEventDetails(event);
        }
    });
    
    document.getElementById('student-schedule').addEventListener('click', (e) => {
        const button = e.target.closest('.scan-qr-btn');
        if (button) {
            const classId = button.dataset.classId;
            startScanner(classId);
        }
    });

    document.getElementById('student-goals').addEventListener('click', (e) => {
         const button = e.target.closest('.breakdown-goal-btn');
        if (button) {
            const goal = button.dataset.goal;
            breakDownGoal(goal);
        }
    });

    document.getElementById('generate-tasks-btn').addEventListener('click', async () => {
        const loader = document.getElementById('tasks-loader');
        const output = document.getElementById('tasks-output');
        const btn = document.getElementById('generate-tasks-btn');
        
        loader.classList.remove('hidden');
        output.innerHTML = '';
        btn.disabled = true;

        const interests = currentUser.profile.interests.join(', ');
        const goals = currentUser.profile.goals.join(', ');
        const prompt = `Act as a helpful academic advisor. For a student interested in "${interests}" with long-term goals like "${goals}", suggest 3 specific, actionable, and creative tasks they can complete in a 1-hour free period. Format as a numbered list with bold headings.`;
        
        const result = await callGeminiAPI(prompt);
        
        const formatted = result
            .replace(/\*\*(.*?)\*\*/g, '<strong class="text-fuchsia-300">$1</strong>')
            .replace(/\n/g, '<br>');
        output.innerHTML = `<div class="prose text-gray-300">${formatted}</div>`;
        loader.classList.add('hidden');
        btn.disabled = false;
    });

    function showEventDetails(event) {
        document.getElementById('event-modal-title').textContent = event.title;
        const eventDate = new Date(`${event.date}T00:00:00`);
        document.getElementById('event-modal-date').textContent = eventDate.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' });
        document.getElementById('event-modal-time').textContent = `${event.startTime} - ${event.endTime}`;
        document.getElementById('event-modal-location').textContent = event.location;
        document.getElementById('event-modal-organizer').textContent = event.organizer;
        document.getElementById('event-modal-description').textContent = event.description;
        document.getElementById('event-details-modal').classList.remove('hidden');
    }

    async function breakDownGoal(goal) {
        const modal = document.getElementById('goal-modal');
        const loader = document.getElementById('goal-modal-loader');
        const content = document.getElementById('goal-modal-content');
        
        modal.classList.remove('hidden');
        loader.classList.remove('hidden');
        content.innerHTML = '';
        document.getElementById('goal-modal-title').textContent = `Breaking down: "${goal}"`;

        const prompt = `Break down this large goal: "${goal}" into 5 smaller, manageable steps for a student. Provide a simple numbered list.`;
        const result = await callGeminiAPI(prompt);
        
        const formattedResult = result.split('\n').map(line => line.trim()).filter(Boolean).map(line => {
            return `<div class="flex items-start gap-3 mt-2">
                        <span class="flex-shrink-0 bg-fuchsia-500/30 text-fuchsia-200 font-bold w-6 h-6 text-sm rounded-full flex items-center justify-center">${line.split('.')[0]}</span>
                        <p>${line.replace(/^\d+\.\s*/, '')}</p>
                    </div>`;
        }).join('');

        content.innerHTML = formattedResult;
        loader.classList.add('hidden');
    }
    
    async function startScanner(targetClassId) {
        const modal = document.getElementById('scanner-modal');
        modal.classList.remove('hidden');

        if (html5QrCode && html5QrCode.isScanning) {
            try { await html5QrCode.stop(); } catch (err) { /* ignore */ }
        }

        html5QrCode = new Html5Qrcode("qr-reader");

        const onScanSuccess = (decodedText) => {
            try {
                const data = JSON.parse(decodedText);
                if (data.classId && data.classId === targetClassId && data.token) {
                    html5QrCode.stop().then(() => {
                        modal.classList.add('hidden');
                        markAttendance(currentUser.id, data.classId);
                    });
                } else if (data.classId !== targetClassId) {
                    showToast('Incorrect QR Code for this class.', 'error');
                } else {
                    showToast('This QR code is invalid or expired.', 'error');
                }
            } catch (e) {
                showToast("Invalid QR Code format.", 'error');
            }
        };

        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, onScanSuccess, (err) => {})
            .catch(() => {
                showToast('Could not start camera. Please grant permissions.', 'error');
                modal.classList.add('hidden');
            });
    }
    
    function markAttendance(studentId, classId) {
        const today = new Date().toISOString().split('T')[0];
        const attendanceId = `${today}_${classId}_${studentId}`;
        localDB.attendance[attendanceId] = { studentId, classId, date: today, status: 'present' };
        localStorage.setItem('attendanceData', JSON.stringify(localDB.attendance));
        showToast('Attendance marked successfully!');
    }

    // --- TEACHER & ADMIN DASHBOARDS ---
    function renderTeacherDashboard() {
        document.getElementById('teacher-name').textContent = currentUser.name;
        const classSelect = document.getElementById('class-select');
        classSelect.innerHTML = '';

        const classes = localDB.timetable.classes.filter(c => c.teacherId === currentUser.id);
        classes.forEach(cls => {
            const option = document.createElement('option');
            option.value = cls.classId;
            option.textContent = `${cls.classId} - ${cls.subject}`;
            classSelect.appendChild(option);
        });

        if (classes.length > 0) {
            loadAttendanceForClass(classes[0].classId);
        } else {
            document.getElementById('attendance-grid').innerHTML = '<p class="text-sm text-gray-400 col-span-full">No classes assigned.</p>';
        }
        
        classSelect.onchange = (e) => loadAttendanceForClass(e.target.value);
        document.getElementById('generate-qr-btn').onclick = generateQrCode;
        showView('teacher-view');
    }
    
    function loadAttendanceForClass(classId) {
        const attendanceGrid = document.getElementById('attendance-grid');
        attendanceGrid.innerHTML = '';
        const classInfo = localDB.timetable.classes.find(c => c.classId === classId);
        const today = new Date().toISOString().split('T')[0];

        classInfo.students.forEach(studentId => {
            const studentData = localDB.users[studentId];
            if (studentData) {
                const attendanceId = `${today}_${classId}_${studentId}`;
                const isPresent = localDB.attendance[attendanceId]?.status === 'present';
                const studentCard = document.createElement('div');
                studentCard.className = 'p-3 rounded-lg border border-white/10 flex items-center space-x-3 bg-white/5';
                studentCard.innerHTML = `
                    <span class="status-dot ${isPresent ? 'status-present' : 'status-absent'}"></span>
                    <div>
                        <p class="font-semibold text-sm text-white">${studentData.name}</p>
                        <p class="text-xs text-gray-400">${studentId}</p>
                    </div>
                `;
                attendanceGrid.appendChild(studentCard);
            }
        });
    }
    
    function generateQrCode() {
        const classId = document.getElementById('class-select').value;
        if (!classId) {
            showToast("Please select a class first.", "error");
            return;
        }
        const token = `${classId}-${Date.now()}`;
        const qrData = JSON.stringify({ classId: classId, token: token });

        QRCode.toCanvas(document.getElementById('qrcode'), qrData, { width: 220, margin: 1 }, (error) => {
            if (error) {
                showToast('Failed to generate QR code.', 'error');
                return;
            }
            document.getElementById('qr-modal-class-info').textContent = `For class: ${classId}`;
            document.getElementById('qr-modal').classList.remove('hidden');
        });
    }
    
    function renderAdminDashboard() {
        document.getElementById('admin-name').textContent = currentUser.name;
        let studentCount = 0, teacherCount = 0;
        Object.values(localDB.users).forEach(user => {
            if (user.role === 'student') studentCount++;
            if (user.role === 'teacher') teacherCount++;
        });
        
        const today = new Date().toISOString().split('T')[0];
        const presentCount = Object.values(localDB.attendance).filter(a => a.date === today && a.status === 'present').length;
        const totalPossibleAttendances = localDB.timetable.classes.reduce((sum, c) => sum + (c.students?.length || 0), 0);
        const attendancePercentage = totalPossibleAttendances > 0 ? ((presentCount / totalPossibleAttendances) * 100).toFixed(1) : 0;

        document.getElementById('total-students').textContent = studentCount;
        document.getElementById('total-teachers').textContent = teacherCount;
        document.getElementById('overall-attendance').textContent = `${attendancePercentage}%`;

        showView('admin-view');
    }

    // --- EVENT MANAGER DASHBOARD ---
    function renderEventManagerDashboard() {
        document.getElementById('event-manager-name').textContent = currentUser.name;
        renderEventManagerEvents();
        showView('event-manager-view');
    }

    function renderEventManagerEvents() {
        const listContainer = document.getElementById('event-list-manager');
        listContainer.innerHTML = '';
        if (localDB.events.length === 0) {
             listContainer.innerHTML = `<p class="text-sm text-gray-400">No events created yet.</p>`;
             return;
        }
        localDB.events
            .sort((a,b) => new Date(b.date) - new Date(a.date))
            .forEach(event => {
                const eventEl = document.createElement('div');
                eventEl.className = 'p-3 rounded-lg bg-white/5 border border-white/10';
                eventEl.innerHTML = `
                    <p class="font-semibold text-white">${event.title}</p>
                    <p class="text-sm text-gray-300">${new Date(event.date + 'T00:00:00').toLocaleDateString()} at ${event.startTime}</p>
                `;
                listContainer.appendChild(eventEl);
        });
    }
    
    document.getElementById('create-event-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const newEvent = {
            id: `evt-${Date.now()}`,
            title: document.getElementById('event-title').value,
            date: document.getElementById('event-date').value,
            startTime: document.getElementById('event-start-time').value,
            endTime: document.getElementById('event-end-time').value,
            location: document.getElementById('event-location').value,
            organizer: document.getElementById('event-organizer').value,
            description: document.getElementById('event-description').value,
        };

        localDB.events.push(newEvent);
        localStorage.setItem('eventData', JSON.stringify(localDB.events));
        
        showToast('Event created successfully!', 'success');
        document.getElementById('create-event-form').reset();
        renderEventManagerEvents();
    });

    // --- MODAL CLOSE HANDLERS ---
    document.getElementById('close-qr-modal').addEventListener('click', () => document.getElementById('qr-modal').classList.add('hidden'));
    document.getElementById('close-goal-modal').addEventListener('click', () => document.getElementById('goal-modal').classList.add('hidden'));
    document.getElementById('close-event-modal').addEventListener('click', () => document.getElementById('event-details-modal').classList.add('hidden'));
    document.getElementById('close-scanner-modal').addEventListener('click', async () => {
        if (html5QrCode && html5QrCode.isScanning) {
            try { await html5QrCode.stop(); } catch (err) {}
        }
        document.getElementById('scanner-modal').classList.add('hidden');
    });

    // --- INITIALIZE THE APP ---
    function initializeApp() {
        setupInitialData();
        
        const savedAttendance = localStorage.getItem('attendanceData');
        if (savedAttendance) localDB.attendance = JSON.parse(savedAttendance);
        
        const savedEvents = localStorage.getItem('eventData');
        if (savedEvents) {
             localDB.events = JSON.parse(savedEvents);
        } else {
            localStorage.setItem('eventData', JSON.stringify(localDB.events));
        }

        localStorage.removeItem('activeQrTokens');
        setTimeout(() => showView('login-view'), 500);
    }
    initializeApp();

</script>
</body>
</html>

